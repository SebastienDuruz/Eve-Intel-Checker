<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@page "/"
@using EveIntelChecker.Models.Database
@using EveIntelChecker.Data
@using EveIntelChecker.Models
@using Microsoft.AspNetCore.Components.Forms
@using System.IO

@inject EveStaticDatabase EveStaticDb

<PageTitle>IntelChecker</PageTitle>
<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="d-flex py-2 gap-4">
    <div>
        <InputFile id="fileInput" OnChange="SelectFile" hidden multiple accept=".txt" />
        <MudFab HtmlTag="label" Color="@_fileIconColor" Icon="@Icons.Filled.ChatBubble" Size="Size.Small" for="fileInput" id="fileIcon"></MudFab>
    </div>
    <div>
        <MudAutocomplete T="MapSolarSystem" Label="Actual position" Immediate="true" @bind-value="_selectedSystem" @onselect="BuildSystemsList" SearchFunc="@SearchSystem" ResetValueOnEmptyText="true" ToStringFunc="@(e=> e==null?null : $"{e.SolarSystemName}")" Dense="true" Margin="Margin.Dense" AdornmentColor="Color.Primary" Variant="Variant.Outlined" />
    </div>
</MudContainer>
@if (_intelSystems.Count() == 0)
{
    <MudText>Select a system</MudText>
}
else
{
    <MudStack Spacing="0">
        <MudPaper Elevation="0" Class="d-flex gap-7" Style="width: 100%;">
            <MudText Class="flex-auto">Jumps</MudText>
            <MudText Class="flex-auto">System</MudText>
            <MudText Class="flex-auto">Triggers</MudText>
        </MudPaper>
        @foreach (IntelSystem system in _intelSystems)
        {
            string classes = _clearClasses;
            @if(system.IsRed)
            {
                classes += _redClasses;
            }
            else if(system.TriggerCounter > 0)
            {
                classes += _orangeClasses;
            }
            
            <MudPaper Elevation="0" Class="@classes" Style="width: 100%;">
                <MudText Class="flex-auto" Style="width: 28%;">@system.Jumps</MudText>
                <MudMenu Class="flex-auto " Style="width: 55%;" Dense="true" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft">
                    <ActivatorContent>
                        <MudText>@system.SystemName</MudText>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Href="@($"https://zkillboard.com/system/{system.SystemId}")">ZKillboard</MudMenuItem>
                        <MudMenuItem Href="@($"https://evemaps.dotlan.net/map/{system.SystemDomainName.Replace(" ", "_")}/{system.SystemName}")">Dotlan</MudMenuItem>
                    </ChildContent>
                </MudMenu>
                <MudText Class="flex-auto" Style="width: 5%;">@system.TriggerCounter</MudText>
            </MudPaper>
        }
    </MudStack>
}

@code {
    private System.Threading.Timer? _readFileTimer;
    private MapSolarSystem _selectedSystem;
    private List<IntelSystem> _intelSystems = new List<IntelSystem>();
    private string _logFilePath = "";
    private string _copyLogFilePath = "";
    private string _lastLogFileLine = "";
    private IBrowserFile _logFile = null;
    private Color _fileIconColor = Color.Error;
    private string _redClasses = " mud-error-text";
    private string _orangeClasses = " mud-secondary-text";
    private string _clearClasses = "d-flex gap-4";

    protected override async Task OnInitializedAsync()
    {
        _readFileTimer = new System.Threading.Timer(async (object? stateInfo) =>
        {
            await ReadLogFile();
        }, new System.Threading.AutoResetEvent(false), 1000, 1000);
    }

    private void SelectFile(InputFileChangeEventArgs e)
    {
        // Only the last selected file will be used
        foreach (var file in e.GetMultipleFiles())
            _logFile = file;

        if (_logFile != null && _logFile.ContentType == "text/plain")
        {
            _fileIconColor = Color.Success;
            _logFilePath = $"{Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments)}\\EVE\\logs\\Chatlogs\\{_logFile.Name}";
            _copyLogFilePath = $"{Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments)}\\EVE\\logs\\Chatlogs\\Copy_{_logFile.Name}";
        }
        else
        {
            _fileIconColor = Color.Error;
            _logFile = null;
            _logFilePath = "";
            _copyLogFilePath = "";
        }
    }

    private async Task<IEnumerable<MapSolarSystem>> SearchSystem(string value)
    {
        if (string.IsNullOrEmpty(value))
            return new List<MapSolarSystem>();
        return EveStaticDb.SolarSystems.Where(x => x.SolarSystemName.Contains(value, StringComparison.InvariantCultureIgnoreCase) || x.SolarSystemID.ToString().Contains(value, StringComparison.InvariantCultureIgnoreCase)).ToList();
    }

    private void BuildSystemsList()
    {
        this._intelSystems = EveStaticDb.BuildSystemsList(_selectedSystem);
    }

    private async Task ReadLogFile()
    {
        // User has selected the required 
        if(_logFile != null && _intelSystems.Count > 0)
            if(File.Exists(_logFilePath))
            {
                if (File.Exists(_copyLogFilePath))
                    File.Delete(_copyLogFilePath);
                File.Copy(_logFilePath, _copyLogFilePath);
                string[] lines = await File.ReadAllLinesAsync(_copyLogFilePath);
                if(lines != null)
                    if(lines[lines.Count() - 1] != _lastLogFileLine)
                    {
                        _lastLogFileLine = lines[lines.Count() - 1];
                        await CheckSystemProximity();
                        InvokeAsync(() => StateHasChanged());
                    }
            }
    }

    private async Task CheckSystemProximity()
    {
        foreach(IntelSystem intelSystem in _intelSystems)
            if (_lastLogFileLine.Contains(intelSystem.SystemName))
                ++intelSystem.TriggerCounter;
    }
}

